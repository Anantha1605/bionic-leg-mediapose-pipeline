# Arduino Leg Controller (2 legs, 6 servos)

This folder contains an Arduino sketch and a Python uploader to control a two-legged robot
with 3 DOF per leg (6 MG996 servos total) using `output_angles.csv`.

Files
- `ArduinoLegController.ino` - Arduino sketch. Reads serial commands and moves servos smoothly.
- `send_csv_to_arduino.py` - Python script to stream rows from `output_angles.csv` to an Arduino.
- `calibration` - optional small text/json file you can create with per-servo offsets and invert flags.

Wiring notes
- MG996 servos require a stable 5V supply. Do NOT power them from the Arduino 5V regulator when under load. Use an external 5V supply capable of several amps.
- Connect servo VCC to external 5V, servo GND to the external supply GND, and connect that GND to the Arduino GND as well (common ground).
- Default servo signal pins in the sketch:
  - Right hip: pin 3
  - Right knee: pin 5
  - Right ankle: pin 6
  - Left hip: pin 9
  - Left knee: pin 10
  - Left ankle: pin 11
  Change pins in the sketch if your wiring differs.

Usage
1. Open `ArduinoLegController.ino` in the Arduino IDE and upload to your board (e.g., Arduino Uno).
2. Install pyserial on your PC: `pip install pyserial`.
3. From the workspace root run one of the examples below.

Send both legs (recommended when CSV has both sides):

```bash
python send_csv_to_arduino.py --port COM3 --baud 115200 --side B --delay 40
```

Send only right or left leg (if CSV or use-case requires):

```bash
python send_csv_to_arduino.py --port COM3 --baud 115200 --side R --delay 40
python send_csv_to_arduino.py --port COM3 --baud 115200 --side L --delay 40
```

- Use `--dry-run` to only print commands without sending.
- Use `--skip-empty` to skip rows with missing angles.

Calibration
- The Arduino stores calibration per servo (offset in degrees and invert flag) in EEPROM. The uploader can push calibration entries before streaming.
- Calibration file formats supported:
  - JSON: list of objects: [{"idx":0,"offset":-2.5,"invert":0}, ...]
  - CSV: lines of `servo_idx,offset,invert` (e.g. `0,-2.5,0`)

Example: upload calibration then stream

```bash
python send_csv_to_arduino.py --port COM3 --baud 115200 --cal-file mycal.json --apply-cal --side B
```

- The uploader sends `CAL,<idx>,<offset>,<invert>` commands and then `SAVE_CAL` to write into EEPROM.
- You can also use a serial monitor and send `DUMP_CAL` to print stored calibration lines.

Notes
- The Arduino sketch applies simple smoothing by stepping 1 degree at a time with a short delay.
- Use calibration offsets to correct mechanical mounting differences; use invert flags if a servo is mounted mirrored.
- If your servos are noisy or jittery, consider lowering STEP_DELAY_MS or increasing delays between CSV rows.

Safety
- Keep servo movement limits within safe mechanical ranges for your robot.
- Test with `--dry-run` first to verify the commands generated by the CSV.
# Arduino Leg Controller

This folder contains an Arduino sketch and a Python uploader to control a 3-DOF robotic leg
using three MG996 servos (hip, knee, ankle) from a CSV file (`output_angles.csv`).

Files
- `ArduinoLegController.ino` - Arduino sketch. Reads serial commands and moves servos smoothly.
- `send_csv_to_arduino.py` - Python script to stream rows from `output_angles.csv` to an Arduino.

Wiring notes
- MG996 servos require a stable 5V supply. Do NOT power more than one or two continuously from the
  Arduino 5V regulator. Prefer an external 5V power supply capable of several amps.
- Connect servo VCC to external 5V, servo GND to the external supply GND, and connect that GND
  to the Arduino GND as well (common ground).
- Connect servo signal wires to the pins defined in the sketch: HIP=9, KNEE=10, ANKLE=11 (change in code if needed).

Safety
- Keep servo movement limits within safe mechanical ranges for your robot.
- Test with `--dry-run` first to verify the commands generated by the CSV.

Usage
1. Open `ArduinoLegController.ino` in the Arduino IDE and upload to your board (e.g., Arduino Uno).
2. Install pyserial on your PC: `pip install pyserial`.
3. From the workspace root run:

```bash
python send_csv_to_arduino.py --port COM3 --baud 115200 --side R --delay 40
```

- Use `--dry-run` to only print commands without sending.
- Use `--side L` to use left leg columns from `output_angles.csv`.

CSV expectations
- The repo `output_angles.csv` has columns: `right_hip_angle`, `right_knee_angle`, `right_ankle_angle`,
  and corresponding `left_*` columns. The uploader sends integer-degree values to the Arduino.

Notes
- The Arduino sketch applies a simple smoothing by stepping 1 degree at a time with a short delay.
- You may want to adapt mapping functions if your servos are mounted reversed or require offsets.
